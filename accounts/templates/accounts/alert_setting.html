{% extends "base.html" %}
{% block content %}

<h1 class="h5 mb-3">アラート設定</h1>

<form id="alertSettingForm" method="post" action="{% url 'accounts:alert_setting' %}">
  {% csrf_token %}

  <div class="mb-3">
    <label class="form-label">個数アラート（◯個以下で通知）</label>
    {{ form.quantity_threshold }}
    <div class="form-text">例：1 → 1個以下で通知</div>
  </div>

  <div class="mb-3">
    <label class="form-label">期限アラート（残り◯日以内で通知）</label>
    {{ form.expiry_days }}
    <div class="form-text">例：30 → 30日以内で通知</div>
  </div>

  <button class="btn btn-primary w-100" type="submit">保存</button>
</form>

<!-- トースト（Bootstrap想定） -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="saveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body" id="toastBody">保存しました</div>
  </div>
</div>

<script>
  // DOMが読み込まれてから動かす（スマホでも安全）
  document.addEventListener("DOMContentLoaded", () => {
    // ★ formを必ず取得（これが無いと form.addEventListener で落ちる）
    const form = document.getElementById("alertSettingForm");

    // ★ Toast用の要素（IDはあなたのHTMLに合わせている想定）
    // もしIDが違う場合は、alert_setting.html内の実際のIDに合わせてここだけ直す
    const toastEl = document.getElementById("saveToast");
    const toastBody = document.getElementById("toastBody");

    // もし form が取れないなら、ここで止める（デバッグに役立つ）
    if (!form) {
      console.error("alertSettingForm が見つかりません");
      return;
    }

    // メッセージ表示：Bootstrap ToastがあればToast、無ければalertで代替
    function showMessage(msg) {
      // toast要素があり、かつ bootstrap が使える場合のみToast
      if (toastEl && toastBody && window.bootstrap && bootstrap.Toast) {
        toastBody.textContent = msg;
        new bootstrap.Toast(toastEl).show();
      } else {
        // 提出直前の保険：Bootstrap無しでも必ず表示される
        alert(msg);
      }
    }

    // CSRFトークンをCookieから取る（Djangoの定番）
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return null;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const csrftoken = getCookie("csrftoken");

      try {
        const res = await fetch(form.action, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": csrftoken,
          },
          body: formData,
        });

        // レスポンス本文をまずテキストで読む（JSONでもHTMLでも落ちない）
        const text = await res.text();
        console.log("alert save status:", res.status, "body:", text);

        // 失敗（403/404/500など）
        if (!res.ok) {
          showMessage("入力内容を確認してください");
          return;
        }

        // 成功：JSONなら message を表示、JSONでなくても「保存しました」
        try {
          const data = JSON.parse(text);
          showMessage(data.message || "保存しました");
        } catch {
          showMessage("保存しました");
        }

      } catch (err) {
        console.error(err);
        showMessage("通信エラーが発生しました");
      }
    });
  });
</script>

{% endblock %}